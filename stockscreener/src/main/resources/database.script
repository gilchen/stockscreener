CREATE TABLE BSE_ICICI_MAPPING(
	STOCK_CODE VARCHAR(10),
	SC_CODE INT(11),
	PRIMARY KEY (STOCK_CODE)
);

CREATE TABLE ALERT(
	ALERT_ID BIGINT AUTO_INCREMENT,
	STOCK_CODE VARCHAR(10),
	TRX_TYPE VARCHAR(20),
	EVENT_DATE DATE,
	OPPORTUNITY_TYPE VARCHAR(50),
	EVENT_PRICE DOUBLE,
	TARGET_PRICE VARCHAR(20),
	SLTP DOUBLE NULL,
	EVENT_TYPE VARCHAR(50),
	QTY INT(5),
	IS_ACTIVE CHAR(1),
	PRIMARY KEY (ALERT_ID),
	FOREIGN KEY (STOCK_CODE) REFERENCES BSE_ICICI_MAPPING (STOCK_CODE)
);

CREATE TABLE NYSE_ALERT(
	ALERT_ID BIGINT AUTO_INCREMENT,
	SYMBOL VARCHAR(30),
	TRX_TYPE VARCHAR(20),
	EVENT_DATE DATE,
	OPPORTUNITY_TYPE VARCHAR(50),
	EVENT_PRICE DOUBLE,
	TARGET_PRICE VARCHAR(20),
	EVENT_TYPE VARCHAR(50),
	QTY INT(5),
	IS_ACTIVE CHAR(1),
	PRIMARY KEY (ALERT_ID)
);

CREATE TABLE BSE(
	TRADE_DATE  DATE
	SC_CODE     INT(11)
	SC_NAME     VARCHAR(30)
	SC_GROUP    VARCHAR(10)
	SC_TYPE     VARCHAR(10)
	OPEN        DOUBLE
	HIGH        DOUBLE
	LOW         DOUBLE
	CLOSE       DOUBLE
	LAST        DOUBLE
	PREVCLOSE   DOUBLE
	NO_TRADES   BIGINT(20)
	NO_OF_SHRS  BIGINT(20)
	NET_TURNOV  DOUBLE
	TDCLOINDI   VARCHAR(10),
	PRIMARY KEY (TRADE_DATE, SC_CODE)
);

CREATE TABLE NYSE(
	TRADE_DATE  DATE,
	SYMBOL      VARCHAR(30),
	OPEN        DOUBLE,
	HIGH        DOUBLE,
	LOW         DOUBLE,
	CLOSE       DOUBLE,
	VOLUME      BIGINT(20),
	PRIMARY KEY (TRADE_DATE, SYMBOL)
);

CREATE TABLE KEY_VALUE(
	K VARCHAR(50),
	V VARCHAR(50),
	PRIMARY KEY (K)
);

CREATE TABLE REPORT(
	REPORT_NAME VARCHAR(50),
	CONTENT     MEDIUMTEXT,
	PRIMARY KEY(REPORT_NAME)
);

CREATE TABLE HOLIDAYS(
	HOLIDAY DATE,
	PRIMARY KEY(HOLIDAY)
);

CREATE TABLE NYSE_TX(
	NYSE_TX_ID BIGINT AUTO_INCREMENT,
	TRX_TYPE VARCHAR(20),
	SYMBOL VARCHAR(30),
	TX_DATE DATE,
	PRICE DOUBLE,
	QTY INT(5),
	TX_FEE DOUBLE,
	COMMENTS VARCHAR(100),
	PRIMARY KEY (NYSE_TX_ID)
);

CREATE TABLE SUMMARY_52_WK_NYSE(
	SNAPSHOT_DT DATE,
	SYMBOL VARCHAR(30),
	MIN_LOW DOUBLE,
	MAX_HIGH DOUBLE,
	MIN_CLOSE DOUBLE,
	MAX_CLOSE DOUBLE
);

CREATE TABLE SUMMARY_104_WK_NYSE(
	SNAPSHOT_DT DATE,
	SYMBOL VARCHAR(30),
	MIN_LOW DOUBLE,
	MAX_HIGH DOUBLE,
	MIN_CLOSE DOUBLE,
	MAX_CLOSE DOUBLE
);

CREATE TABLE SUMMARY_156_WK_NYSE(
	SNAPSHOT_DT DATE,
	SYMBOL VARCHAR(30),
	MIN_LOW DOUBLE,
	MAX_HIGH DOUBLE,
	MIN_CLOSE DOUBLE,
	MAX_CLOSE DOUBLE
);

CREATE TABLE SUMMARY_52_WK_BSE(
	SNAPSHOT_DT DATE,
	SC_CODE INT(11),
	MIN_LOW DOUBLE,
	MAX_HIGH DOUBLE,
	MIN_CLOSE DOUBLE,
	MAX_CLOSE DOUBLE
);

CREATE TABLE SYMBOL_METADATA(
	SYMBOL VARCHAR(30),
	SHARES_OUTSTANDING VARCHAR(30),
	EXPANDED_SHARES_OUTSTANDING BIGINT(20),
	PRIMARY KEY(SYMBOL)
);
/*
	mysql>LOAD DATA LOCAL INFILE 'C:/Temp/ForSrid/so/output/symbol_metadata.csv' INTO TABLE symbol_metadata FIELDS TERMINATED BY ',' LINES TERMINATED BY '\n';
	mysql>UPDATE SYMBOL_METADATA SET SHARES_OUTSTANDING=NULL, EXPANDED_SHARES_OUTSTANDING=NULL WHERE SHARES_OUTSTANDING = 'NULL';
*/

/*
CREATE TEMPORARY TABLE TMP1(
	ID BIGINT AUTO_INCREMENT,
	TRADE_DATE  DATE,
	SYMBOL      VARCHAR(30),
	OPEN        DOUBLE,
	HIGH        DOUBLE,
	LOW         DOUBLE,
	CLOSE       DOUBLE,
	VOLUME      BIGINT(20),
	PRIMARY KEY (ID)
);

CREATE TEMPORARY TABLE TMP2(
	ID BIGINT AUTO_INCREMENT,
	TRADE_DATE  DATE,
	SYMBOL      VARCHAR(30),
	OPEN        DOUBLE,
	HIGH        DOUBLE,
	LOW         DOUBLE,
	CLOSE       DOUBLE,
	VOLUME      BIGINT(20),
	PRIMARY KEY (ID)
);

INSERT INTO TMP1 (TRADE_DATE, SYMBOL, OPEN, HIGH, LOW, CLOSE, VOLUME) SELECT * FROM NYSE WHERE SYMBOL='TBT' AND TRADE_DATE >= '2011-01-03' ORDER BY TRADE_DATE ASC;
INSERT INTO TMP2 (TRADE_DATE, SYMBOL, OPEN, HIGH, LOW, CLOSE, VOLUME) SELECT * FROM NYSE WHERE SYMBOL='TBT' AND TRADE_DATE >  '2011-01-03' ORDER BY TRADE_DATE ASC;

SELECT A.TRADE_DATE, B.TRADE_DATE, A.CLOSE, B.HIGH, ROUND( ((B.HIGH-A.CLOSE)/A.CLOSE)*100.0 , 2) DIFF FROM
	TMP1 A,
	TMP2 B
WHERE
	A.ID=B.ID;
----------------

SELECT	
	A.TRADE_DATE,
	B.TRADE_DATE,
	A.CLOSE PREV_CLOSE,
	B.LOW,
	B.HIGH,
	ROUND( (IF( A.CLOSE > B.HIGH, A.CLOSE, B.HIGH ) - IF( A.CLOSE > B.LOW, B.LOW, A.CLOSE ) ), 2) SPREAD,
	ROUND( ((((IF( A.CLOSE > B.HIGH, A.CLOSE, B.HIGH ) - IF( A.CLOSE > B.LOW, B.LOW, A.CLOSE ) ) - A.CLOSE)/A.CLOSE)*100.0)+100.0, 2) SPREAD_PC
FROM	
	TMP1 A,
	TMP2 B
WHERE	
	A.ID=B.ID;
---------------
SELECT
	A.TRADE_DATE,
	B.TRADE_DATE,
	A.CLOSE PREV_CLOSE,
	B.LOW,
	ROUND( ((B.LOW-A.CLOSE)/A.CLOSE)*100.0, 2) LOW_PC,
	B.CLOSE,
	ROUND( ((B.CLOSE-A.CLOSE)/A.CLOSE)*100.0, 2) CLOSE_PC
FROM
	TMP1 A,
	TMP2 B
WHERE
	A.ID=B.ID
	AND B.LOW < (A.CLOSE - (A.CLOSE * 0.06));

SELECT 
	(SELECT
		COUNT(*)
		/*
		A.TRADE_DATE,
		B.TRADE_DATE,
		A.CLOSE PREV_CLOSE,
		B.HIGH,
		ROUND( ((B.HIGH-A.CLOSE)/A.CLOSE)*100.0, 2) HIGH_PC,
		B.CLOSE,
		ROUND( ((B.CLOSE-A.CLOSE)/A.CLOSE)*100.0, 2) CLOSE_PC
		*/
	FROM
		TMP1 A,
		TMP2 B
	WHERE
		A.ID=B.ID
		AND B.HIGH > (A.CLOSE + (A.CLOSE * 0.00)) AND B.HIGH < (A.CLOSE + (A.CLOSE * 0.02))
	) _0_2;


SELECT 
	(SELECT
		COUNT(*)
		/*
		A.TRADE_DATE,
		B.TRADE_DATE,
		A.CLOSE PREV_CLOSE,
		B.HIGH,
		ROUND( ((B.HIGH-A.CLOSE)/A.CLOSE)*100.0, 2) HIGH_PC,
		B.CLOSE,
		ROUND( ((B.CLOSE-A.CLOSE)/A.CLOSE)*100.0, 2) CLOSE_PC
		*/
	FROM
		TMP1 A,
		TMP2 B
	WHERE
		A.ID=B.ID
		AND B.LOW < (A.CLOSE - (A.CLOSE * 0.00)) AND B.LOW > (A.CLOSE - (A.CLOSE * 0.02))
	) _0_2;

// Query to find symbols that are (5-10%) up from their 52 week lows
// Considers trade_date to be last business day.
// Considers 12 months of data only.
select * from 
	(select symbol, close, volume from nyse n1 where trade_date=(select max(trade_date) from nyse where symbol='DJI.IDX' and volume>0) and (symbol not like '%-%' and symbol not like '%.%') and (close*volume) > 100000000) a,
	SUMMARY_52_WK_NYSE b
where
	a.symbol=b.symbol and
	a.close between (b.min_low + (b.min_low*(5/100))) and (b.min_low + (b.min_low*(10/100)));

*/

/*
# Query 1 (More than 80% Down from 52W-High)
# =======
# a) 
SELECT 
	A.SYMBOL, A.CLOSE, A.VOLUME, B.SNAPSHOT_DT, B.MIN_LOW, B.MAX_HIGH, B.MIN_CLOSE, B.MAX_CLOSE, ROUND( ((A.CLOSE-B.MIN_CLOSE)/B.MIN_CLOSE)*100.0, 2) LOW_PC, ROUND( ((A.CLOSE-B.MAX_CLOSE)/B.MAX_CLOSE)*100.0, 2) HIGH_PC
FROM 
	(SELECT SYMBOL, CLOSE, VOLUME FROM NYSE N1 WHERE TRADE_DATE=(SELECT MAX(TRADE_DATE) FROM NYSE WHERE SYMBOL='DJI.IDX' AND VOLUME>0) AND (SYMBOL NOT LIKE '%-%' AND SYMBOL NOT LIKE '%.%') AND (CLOSE*VOLUME) > 1000000) A,
	SUMMARY_52_WK_NYSE B
WHERE
	A.SYMBOL=B.SYMBOL AND
	A.CLOSE <= (B.MAX_HIGH - (B.MAX_HIGH*(80/100)))
UNION
# b)
SELECT 
	A.SYMBOL, A.CLOSE, A.VOLUME, B.SNAPSHOT_DT, B.MIN_LOW, B.MAX_HIGH, B.MIN_CLOSE, B.MAX_CLOSE, ROUND( ((A.CLOSE-B.MIN_CLOSE)/B.MIN_CLOSE)*100.0, 2) LOW_PC, ROUND( ((A.CLOSE-B.MAX_CLOSE)/B.MAX_CLOSE)*100.0, 2) HIGH_PC
FROM 
	(SELECT SYMBOL, CLOSE, VOLUME FROM NYSE N1 WHERE TRADE_DATE=(SELECT MAX(TRADE_DATE) FROM NYSE WHERE SYMBOL='DJI.IDX' AND VOLUME>0) AND (SYMBOL NOT LIKE '%-%' AND SYMBOL NOT LIKE '%.%') AND (CLOSE*VOLUME) > 1000000) A,
	SUMMARY_104_WK_NYSE B
WHERE
	A.SYMBOL=B.SYMBOL AND
	A.CLOSE <= (B.MAX_HIGH - (B.MAX_HIGH*(80/100)))
UNION
# c)
SELECT 
	A.SYMBOL, A.CLOSE, A.VOLUME, B.SNAPSHOT_DT, B.MIN_LOW, B.MAX_HIGH, B.MIN_CLOSE, B.MAX_CLOSE, ROUND( ((A.CLOSE-B.MIN_CLOSE)/B.MIN_CLOSE)*100.0, 2) LOW_PC, ROUND( ((A.CLOSE-B.MAX_CLOSE)/B.MAX_CLOSE)*100.0, 2) HIGH_PC
FROM 
	(SELECT SYMBOL, CLOSE, VOLUME FROM NYSE N1 WHERE TRADE_DATE=(SELECT MAX(TRADE_DATE) FROM NYSE WHERE SYMBOL='DJI.IDX' AND VOLUME>0) AND (SYMBOL NOT LIKE '%-%' AND SYMBOL NOT LIKE '%.%') AND (CLOSE*VOLUME) > 1000000) A,
	SUMMARY_156_WK_NYSE B
WHERE
	A.SYMBOL=B.SYMBOL AND
	A.CLOSE <= (B.MAX_HIGH - (B.MAX_HIGH*(80/100)))
UNION

# Query 2 (More than 85% Down from 52W-High and Last Close <= $1)
# =======
SELECT
	A.SYMBOL, A.CLOSE, A.VOLUME, B.SNAPSHOT_DT, B.MIN_LOW, B.MAX_HIGH, B.MIN_CLOSE, B.MAX_CLOSE, ROUND( ((A.CLOSE-B.MIN_CLOSE)/B.MIN_CLOSE)*100.0, 2) LOW_PC, ROUND( ((A.CLOSE-B.MAX_CLOSE)/B.MAX_CLOSE)*100.0, 2) HIGH_PC
FROM 
	(SELECT SYMBOL, CLOSE, VOLUME FROM NYSE N1 WHERE TRADE_DATE=(SELECT MAX(TRADE_DATE) FROM NYSE WHERE SYMBOL='DJI.IDX' AND VOLUME>0) AND (SYMBOL NOT LIKE '%-%' AND SYMBOL NOT LIKE '%.%') AND CLOSE <= 1) A,
	SUMMARY_52_WK_NYSE B
WHERE
	A.SYMBOL=B.SYMBOL AND
	A.CLOSE <= (B.MAX_HIGH - (B.MAX_HIGH*(85/100)));
*/


/*
// Query to find best BSE BLUECHIPS
select * from 
	(select SC_CODE, close, NO_OF_SHRS 'volume' from bse b1 where trade_date=(select max(trade_date) from bse where SC_CODE=532977 and NO_OF_SHRS>0) and (SC_CODE in (532977, 532454, 500103, 500087, 533278, 532868, 500010, 500180, 500182, 500440, 500696, 532174, 500209, 500875, 532532, 532286, 500510, 500520, 532500, 532541, 500312, 500325, 500112, 500900, 524715, 532540, 500570, 500400, 500470, 507685)) /*and (close*NO_OF_SHRS) > 100000000)*/) a,
	(select * from SUMMARY_52_WK_BSE where (SC_CODE in (532977, 532454, 500103, 500087, 533278, 532868, 500010, 500180, 500182, 500440, 500696, 532174, 500209, 500875, 532532, 532286, 500510, 500520, 532500, 532541, 500312, 500325, 500112, 500900, 524715, 532540, 500570, 500400, 500470, 507685))) b
where
	a.SC_CODE=b.SC_CODE;
-------------------------

// Query to find best BSE Stocks
select * from 
	(select SC_CODE, close, NO_OF_SHRS 'volume' from bse b1 where trade_date=(select max(trade_date) from bse where SC_CODE=532977 and NO_OF_SHRS>0) and (close*NO_OF_SHRS) > 100000000) a,
	SUMMARY_52_WK_BSE b
where
	a.SC_CODE=b.SC_CODE and
	a.close between (b.min_low + (b.min_low*(5/100))) and (b.min_low + (b.min_low*(10/100)));

*/

/*
// Stocks traded with high volume % of "Outstanding Shares". e.g. Single Day Volume is 70% of "Total Outstanding Shares".
select a.symbol, a.volume, b.SHARES_OUTSTANDING from nyse a, symbol_metadata b where a.trade_date='2012-09-10' and a.symbol=b.symbol and abs((a.volume-b.EXPANDED_SHARES_OUTSTANDING)/b.EXPANDED_SHARES_OUTSTANDING)*100.0 <= 70;
*/
